AWSTemplateFormatVersion: "2010-09-09"
Description: "Second CloudFormation template to deploy the QuickSight related pieces of the VDM to QuickSight solution"

Parameters:
  DataStackName:
    Description: The name of the data stack deployed to process the data from VDM and DMARC
    Type: String

  QuickSightUser:
    Description: User name of QuickSight user (as displayed in QuickSight admin panel). Dashboards created by this template will be owned by this user.
    Type: String

Resources:

    VDMDatabaseQuickSightDataSource:
        Type: "AWS::QuickSight::DataSource"
        Properties:
            Name: "SES VDM DataBase"
            DataSourceId: ses-vdm-database
            AwsAccountId: !Ref AWS::AccountId
            Type: "MYSQL"
            DataSourceParameters: 
                RdsParameters: 
                    InstanceId: 
                      Fn::ImportValue: 
                        !Sub "${DataStackName}-VDMReportingDBID"
                    Database:
                      Fn::ImportValue: 
                       !Sub "${DataStackName}-VDMReportingDBName"
            VpcConnectionProperties: 
                VpcConnectionArn: 
                  Fn::ImportValue: 
                   !Sub "${DataStackName}-QuickSightVPCConnectionARN"
            Credentials:
              SecretArn: 
                Fn::ImportValue: 
                 !Sub "${DataStackName}-VDMReportingDBSecret"

    
    DMARCAthenaQuickSightDataSource:
        Type: "AWS::QuickSight::DataSource"
        Properties:
            Name: "DMARC Athena Data"
            DataSourceId: dmarc-athena-data
            AwsAccountId: !Ref AWS::AccountId
            Type: "ATHENA"
            DataSourceParameters: 
              AthenaParameters: 
                WorkGroup: "primary"

    VDMConfigurationRateQuickSightDataSet: 
        Type: "AWS::QuickSight::DataSet"
        Properties:
            Name: "VDM Configuration Rate Data"
            AwsAccountId: !Ref AWS::AccountId
            DataSetId: "vdm-configuration-rate-data"
            PhysicalTableMap: 
                VDMReportingDatabasePhysical: 
                    RelationalTable: 
                        DataSourceArn: !GetAtt VDMDatabaseQuickSightDataSource.Arn
                        Name: "configuration_set_rate"
                        InputColumns: 
                          - 
                            Name: "CONFIGURATION_SET"
                            Type: "STRING"
                          - 
                            Name: "METRIC_DATE"
                            Type: "DATETIME"
                          - 
                            Name: "DELIVERY_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "END_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "OPEN_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "COMPLAINT_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "PERMANENT_BOUNCE_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "TRANSIENT_BOUNCE_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "CLICK_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_OPEN_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_CLICK_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_COMPLAINT_RATE"
                            Type: "INTEGER"
            LogicalTableMap: 
              VDMReportingDatabaseLogical:
                Alias: VDMReportingDatabasePhysical
                Source: 
                  PhysicalTableId: VDMReportingDatabasePhysical
            ImportMode: "DIRECT_QUERY"
            Permissions: 
              - Principal: !Sub "arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/Admin/${QuickSightUser}"
                Actions: 
                  - "quicksight:DeleteDataSet"
                  - "quicksight:UpdateDataSetPermissions"
                  - "quicksight:PutDataSetRefreshProperties"
                  - "quicksight:CreateRefreshSchedule"
                  - "quicksight:CancelIngestion"
                  - "quicksight:UpdateRefreshSchedule"
                  - "quicksight:ListRefreshSchedules"
                  - "quicksight:DeleteRefreshSchedule"
                  - "quicksight:PassDataSet"
                  - "quicksight:DescribeDataSetRefreshProperties"
                  - "quicksight:DescribeDataSet"
                  - "quicksight:CreateIngestion"
                  - "quicksight:DescribeRefreshSchedule"
                  - "quicksight:ListIngestions"
                  - "quicksight:DescribeDataSetPermissions"
                  - "quicksight:UpdateDataSet"
                  - "quicksight:DeleteDataSetRefreshProperties"
                  - "quicksight:DescribeIngestion"

    VDMConfigurationVolumeQuickSightDataSet: 
        Type: "AWS::QuickSight::DataSet"
        Properties:
            Name: "VDM Configuration Volume Data"
            AwsAccountId: !Ref AWS::AccountId
            DataSetId: "vdm-configuration-volume-data"
            PhysicalTableMap: 
                VDMReportingDatabasePhysical: 
                    RelationalTable: 
                        DataSourceArn: !GetAtt VDMDatabaseQuickSightDataSource.Arn
                        Name: "configuration_set_volume"
                        InputColumns: 
                          - 
                            Name: "CONFIGURATION_SET"
                            Type: "STRING"
                          - 
                            Name: "METRIC_DATE"
                            Type: "DATETIME"
                          - 
                            Name: "DELIVERY_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "SEND_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "OPEN_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "COMPLAINT_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "PERMANENT_BOUNCE_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "TRANSIENT_BOUNCE_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "CLICK_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_OPEN_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_CLICK_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_COMPLAINT_VOLUME"
                            Type: "INTEGER"
            LogicalTableMap: 
              VDMReportingDatabaseLogical:
                Alias: VDMReportingDatabasePhysical
                Source: 
                  PhysicalTableId: VDMReportingDatabasePhysical
            ImportMode: "DIRECT_QUERY"
            Permissions: 
              - Principal: !Sub "arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/Admin/${QuickSightUser}"
                Actions: 
                  - "quicksight:DeleteDataSet"
                  - "quicksight:UpdateDataSetPermissions"
                  - "quicksight:PutDataSetRefreshProperties"
                  - "quicksight:CreateRefreshSchedule"
                  - "quicksight:CancelIngestion"
                  - "quicksight:UpdateRefreshSchedule"
                  - "quicksight:ListRefreshSchedules"
                  - "quicksight:DeleteRefreshSchedule"
                  - "quicksight:PassDataSet"
                  - "quicksight:DescribeDataSetRefreshProperties"
                  - "quicksight:DescribeDataSet"
                  - "quicksight:CreateIngestion"
                  - "quicksight:DescribeRefreshSchedule"
                  - "quicksight:ListIngestions"
                  - "quicksight:DescribeDataSetPermissions"
                  - "quicksight:UpdateDataSet"
                  - "quicksight:DeleteDataSetRefreshProperties"
                  - "quicksight:DescribeIngestion"

    VDMISPRateQuickSightDataSet: 
        Type: "AWS::QuickSight::DataSet"
        Properties:
            Name: "VDM ISP Rate Data"
            AwsAccountId: !Ref AWS::AccountId
            DataSetId: "vdm-isp-rate-data"
            PhysicalTableMap: 
                VDMReportingDatabasePhysical: 
                    RelationalTable: 
                        DataSourceArn: !GetAtt VDMDatabaseQuickSightDataSource.Arn
                        Name: "isp_rate"
                        InputColumns: 
                          - 
                            Name: "ISP"
                            Type: "STRING"
                          - 
                            Name: "METRIC_DATE"
                            Type: "DATETIME"
                          - 
                            Name: "DELIVERY_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "SEND_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "OPEN_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "COMPLAINT_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "PERMANENT_BOUNCE_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "TRANSIENT_BOUNCE_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "CLICK_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_OPEN_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_CLICK_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_COMPLAINT_RATE"
                            Type: "INTEGER"
            LogicalTableMap: 
              VDMReportingDatabaseLogical:
                Alias: VDMReportingDatabasePhysical
                Source: 
                  PhysicalTableId: VDMReportingDatabasePhysical
            ImportMode: "DIRECT_QUERY"
            Permissions: 
              - Principal: !Sub "arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/Admin/${QuickSightUser}"
                Actions: 
                  - "quicksight:DeleteDataSet"
                  - "quicksight:UpdateDataSetPermissions"
                  - "quicksight:PutDataSetRefreshProperties"
                  - "quicksight:CreateRefreshSchedule"
                  - "quicksight:CancelIngestion"
                  - "quicksight:UpdateRefreshSchedule"
                  - "quicksight:ListRefreshSchedules"
                  - "quicksight:DeleteRefreshSchedule"
                  - "quicksight:PassDataSet"
                  - "quicksight:DescribeDataSetRefreshProperties"
                  - "quicksight:DescribeDataSet"
                  - "quicksight:CreateIngestion"
                  - "quicksight:DescribeRefreshSchedule"
                  - "quicksight:ListIngestions"
                  - "quicksight:DescribeDataSetPermissions"
                  - "quicksight:UpdateDataSet"
                  - "quicksight:DeleteDataSetRefreshProperties"
                  - "quicksight:DescribeIngestion"

    VDMISPVolumeQuickSightDataSet: 
        Type: "AWS::QuickSight::DataSet"
        Properties:
            Name: "VDM ISP  Volume Data"
            AwsAccountId: !Ref AWS::AccountId
            DataSetId: "vdm-isp-volume-data"
            PhysicalTableMap: 
                VDMReportingDatabasePhysical: 
                    RelationalTable: 
                        DataSourceArn: !GetAtt VDMDatabaseQuickSightDataSource.Arn
                        Name: "isp_volume"
                        InputColumns: 
                          - 
                            Name: "ISP"
                            Type: "STRING"
                          - 
                            Name: "METRIC_DATE"
                            Type: "DATETIME"
                          - 
                            Name: "DELIVERY_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "SEND_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "OPEN_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "COMPLAINT_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "PERMANENT_BOUNCE_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "TRANSIENT_BOUNCE_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "CLICK_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_OPEN_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_CLICK_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_COMPLAINT_VOLUME"
                            Type: "INTEGER"
            LogicalTableMap: 
              VDMReportingDatabaseLogical:
                Alias: VDMReportingDatabasePhysical
                Source: 
                  PhysicalTableId: VDMReportingDatabasePhysical
            ImportMode: "DIRECT_QUERY"
            Permissions: 
              - Principal: !Sub "arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/Admin/${QuickSightUser}"
                Actions: 
                  - "quicksight:DeleteDataSet"
                  - "quicksight:UpdateDataSetPermissions"
                  - "quicksight:PutDataSetRefreshProperties"
                  - "quicksight:CreateRefreshSchedule"
                  - "quicksight:CancelIngestion"
                  - "quicksight:UpdateRefreshSchedule"
                  - "quicksight:ListRefreshSchedules"
                  - "quicksight:DeleteRefreshSchedule"
                  - "quicksight:PassDataSet"
                  - "quicksight:DescribeDataSetRefreshProperties"
                  - "quicksight:DescribeDataSet"
                  - "quicksight:CreateIngestion"
                  - "quicksight:DescribeRefreshSchedule"
                  - "quicksight:ListIngestions"
                  - "quicksight:DescribeDataSetPermissions"
                  - "quicksight:UpdateDataSet"
                  - "quicksight:DeleteDataSetRefreshProperties"
                  - "quicksight:DescribeIngestion"

    VDMEmailIdentityRateQuickSightDataSet: 
        Type: "AWS::QuickSight::DataSet"
        Properties:
            Name: "VDM Email Identity Rate Data"
            AwsAccountId: !Ref AWS::AccountId
            DataSetId: "vdm-email-identity-rate-data"
            PhysicalTableMap: 
                VDMReportingDatabasePhysical: 
                    RelationalTable: 
                        DataSourceArn: !GetAtt VDMDatabaseQuickSightDataSource.Arn
                        Name: "email_identity_rate"
                        InputColumns: 
                          - 
                            Name: "EMAIL_IDENTITY"
                            Type: "STRING"
                          - 
                            Name: "METRIC_DATE"
                            Type: "DATETIME"
                          - 
                            Name: "DELIVERY_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "SEND_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "OPEN_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "COMPLAINT_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "PERMANENT_BOUNCE_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "TRANSIENT_BOUNCE_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "CLICK_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_OPEN_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_CLICK_RATE"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_COMPLAINT_RATE"
                            Type: "INTEGER"
            LogicalTableMap: 
              VDMReportingDatabaseLogical:
                Alias: VDMReportingDatabasePhysical
                Source: 
                  PhysicalTableId: VDMReportingDatabasePhysical
            ImportMode: "DIRECT_QUERY"
            Permissions: 
              - Principal: !Sub "arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/Admin/${QuickSightUser}"
                Actions: 
                  - "quicksight:DeleteDataSet"
                  - "quicksight:UpdateDataSetPermissions"
                  - "quicksight:PutDataSetRefreshProperties"
                  - "quicksight:CreateRefreshSchedule"
                  - "quicksight:CancelIngestion"
                  - "quicksight:UpdateRefreshSchedule"
                  - "quicksight:ListRefreshSchedules"
                  - "quicksight:DeleteRefreshSchedule"
                  - "quicksight:PassDataSet"
                  - "quicksight:DescribeDataSetRefreshProperties"
                  - "quicksight:DescribeDataSet"
                  - "quicksight:CreateIngestion"
                  - "quicksight:DescribeRefreshSchedule"
                  - "quicksight:ListIngestions"
                  - "quicksight:DescribeDataSetPermissions"
                  - "quicksight:UpdateDataSet"
                  - "quicksight:DeleteDataSetRefreshProperties"
                  - "quicksight:DescribeIngestion"

    VDMEmailIdentityVolumeQuickSightDataSet: 
        Type: "AWS::QuickSight::DataSet"
        Properties:
            Name: "VDM Email Identity Volume Data"
            AwsAccountId: !Ref AWS::AccountId
            DataSetId: "vdm-email-identity-volume-data"
            PhysicalTableMap: 
                VDMReportingDatabasePhysical: 
                    RelationalTable: 
                        DataSourceArn: !GetAtt VDMDatabaseQuickSightDataSource.Arn
                        Name: "email_identity_volume"
                        InputColumns: 
                          - 
                            Name: "EMAIL_IDENTITY"
                            Type: "STRING"
                          - 
                            Name: "METRIC_DATE"
                            Type: "DATETIME"
                          - 
                            Name: "DELIVERY_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "SEND_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "OPEN_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "COMPLAINT_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "PERMANENT_BOUNCE_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "TRANSIENT_BOUNCE_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "CLICK_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_OPEN_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_CLICK_VOLUME"
                            Type: "INTEGER"
                          - 
                            Name: "DELIVERY_COMPLAINT_VOLUME"
                            Type: "INTEGER"
            LogicalTableMap: 
              VDMReportingDatabaseLogical:
                Alias: VDMReportingDatabasePhysical
                Source: 
                  PhysicalTableId: VDMReportingDatabasePhysical
            ImportMode: "DIRECT_QUERY"
            Permissions: 
              - Principal: !Sub "arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/Admin/${QuickSightUser}"
                Actions: 
                  - "quicksight:DeleteDataSet"
                  - "quicksight:UpdateDataSetPermissions"
                  - "quicksight:PutDataSetRefreshProperties"
                  - "quicksight:CreateRefreshSchedule"
                  - "quicksight:CancelIngestion"
                  - "quicksight:UpdateRefreshSchedule"
                  - "quicksight:ListRefreshSchedules"
                  - "quicksight:DeleteRefreshSchedule"
                  - "quicksight:PassDataSet"
                  - "quicksight:DescribeDataSetRefreshProperties"
                  - "quicksight:DescribeDataSet"
                  - "quicksight:CreateIngestion"
                  - "quicksight:DescribeRefreshSchedule"
                  - "quicksight:ListIngestions"
                  - "quicksight:DescribeDataSetPermissions"
                  - "quicksight:UpdateDataSet"
                  - "quicksight:DeleteDataSetRefreshProperties"
                  - "quicksight:DescribeIngestion"

    DMARCQuickSightDataSet:
        Type: "AWS::QuickSight::DataSet"
        Properties:
            Name: "dmarc_sorted"
            DataSetId: "dmarc_sorted"
            AwsAccountId: !Ref AWS::AccountId
            PhysicalTableMap: 
                90351ae6-6b73-43b4-b462-c1f178301e11: 
                    RelationalTable: 
                        DataSourceArn: !GetAtt DMARCAthenaQuickSightDataSource.Arn
                        Catalog: "AwsDataCatalog"
                        Schema:                       
                          Fn::ImportValue: 
                            !Sub "${DataStackName}-GlueDataCatalog"
                        Name: "dmarc_sorted_evaluated"
                        InputColumns: 
                          - 
                            Name: "org_name"
                            Type: "STRING"
                          - 
                            Name: "org_email"
                            Type: "STRING"
                          - 
                            Name: "policy_domain"
                            Type: "STRING"
                          - 
                            Name: "policy_pct"
                            Type: "INTEGER"
                          - 
                            Name: "record_source_ip"
                            Type: "STRING"
                          - 
                            Name: "header_from"
                            Type: "STRING"
                          - 
                            Name: "envelope_from"
                            Type: "STRING"
                          - 
                            Name: "dkim_result"
                            Type: "STRING"
                          - 
                            Name: "spf_result"
                            Type: "STRING"
                          - 
                            Name: "date_begin"
                            Type: "DATETIME"
                          - 
                            Name: "date_end"
                            Type: "DATETIME"
            LogicalTableMap: 
                5c30390c-caaa-467f-be98-13af411cecc0: 
                    Alias: "dmarc_sorted"
                    Source: 
                        PhysicalTableId: "90351ae6-6b73-43b4-b462-c1f178301e11"
            ImportMode: "SPICE"
            Permissions: 
              - Principal: !Sub "arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/Admin/${QuickSightUser}"
                Actions: 
                  - "quicksight:DeleteDataSet"
                  - "quicksight:UpdateDataSetPermissions"
                  - "quicksight:PutDataSetRefreshProperties"
                  - "quicksight:CreateRefreshSchedule"
                  - "quicksight:CancelIngestion"
                  - "quicksight:PassDataSet"
                  - "quicksight:UpdateRefreshSchedule"
                  - "quicksight:ListRefreshSchedules"
                  - "quicksight:DeleteRefreshSchedule"
                  - "quicksight:DescribeDataSetRefreshProperties"
                  - "quicksight:DescribeDataSet"
                  - "quicksight:CreateIngestion"
                  - "quicksight:DescribeRefreshSchedule"
                  - "quicksight:ListIngestions"
                  - "quicksight:DescribeDataSetPermissions"
                  - "quicksight:UpdateDataSet"
                  - "quicksight:DeleteDataSetRefreshProperties"
                  - "quicksight:DescribeIngestion"
